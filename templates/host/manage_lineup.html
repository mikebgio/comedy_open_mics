{% extends "base.html" %}

{% block title %}Manage Lineup - {{ event.name }} - Comedy Open Mic Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            <i class="fas fa-list me-2"></i>Manage Lineup
        </h2>
        <p class="text-muted mb-0">{{ event.show.name }} - {{ event.instance_date.strftime('%A, %B %d, %Y') }}</p>
    </div>
    <div>
        <button type="button" class="btn btn-warning me-2" onclick="randomizeLineup()">
            <i class="fas fa-random me-2"></i>Random Select
        </button>
        <a href="{{ url_for('live_lineup', event_id=event.id) }}" class="btn btn-success me-2">
            <i class="fas fa-eye me-2"></i>Live View
        </a>
        <a href="{{ url_for('host_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-sort me-2"></i>Lineup Order
                </h5>
                <span class="badge bg-info">{{ signups|length }} comedians signed up</span>
            </div>
            <div class="card-body">
                {% if signups %}
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Drag and Drop:</strong> Drag the grip handles to reorder the lineup. Changes are saved automatically.
                        </div>
                    </div>
                    
                    <div id="lineup-container">
                        {% for signup in signups %}
                            <div class="lineup-item border rounded p-3 mb-2 bg-light" data-signup-id="{{ signup.id }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="drag-handle me-3" style="cursor: grab; padding: 5px;">
                                            <i class="fas fa-grip-vertical text-muted fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">
                                                {% if signup.position %}
                                                    <span class="badge bg-primary me-2">#{{ signup.position }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary me-2">TBD</span>
                                                {% endif %}
                                                {% if signup.comedian %}
                                                    {{ signup.comedian.full_name }}
                                                {% else %}
                                                    Guest Comedian
                                                {% endif %}
                                            </h6>
                                            {% if signup.notes %}
                                                <small class="text-muted">{{ signup.notes }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">
                                            Signed up: {{ signup.signup_time.strftime('%I:%M %p') }}
                                        </small>
                                        <form method="POST" action="{{ url_for('cancel_signup', signup_id=signup.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    onclick="return confirm('Remove this comedian from the lineup?')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div id="save-status" class="mt-3 text-center"></div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-user-times fa-3x mb-3"></i>
                        <p>No comedians have signed up for this event yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Event Details
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-1">
                    <i class="fas fa-map-marker-alt text-danger me-2"></i>{{ event.show.venue }}
                </p>
                <p class="mb-1">
                    <i class="fas fa-location-arrow text-warning me-2"></i>{{ event.show.address }}
                </p>
                <p class="mb-1">
                    <i class="fas fa-clock text-info me-2"></i>{{ event.start_time.strftime('%I:%M %p') }}{% if event.end_time %} - {{ event.end_time.strftime('%I:%M %p') }}{% endif %}
                </p>
                <p class="mb-3">
                    <i class="fas fa-users text-success me-2"></i>{{ signups|length }} / {{ event.max_signups }} spots filled
                </p>
                
                {% if event.show.description %}
                    <h6>Description</h6>
                    <p class="text-muted">{{ event.show.description }}</p>
                {% endif %}
                
                <div class="progress mb-2">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ (signups|length / event.max_signups * 100)|round }}%">
                        {{ (signups|length / event.max_signups * 100)|round }}%
                    </div>
                </div>
                <small class="text-muted">Event capacity</small>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>Add Comedian
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('manage_lineup', event_id=event.id) }}">
                    <div class="mb-3">
                        <label for="comedian_name" class="form-label">Comedian Name/Username</label>
                        <input type="text" class="form-control" id="comedian_name" name="comedian_name" 
                               placeholder="Enter username or full name" required>
                        <div class="form-text">Enter registered username or any name for walk-ins</div>
                    </div>
                    <button type="submit" name="add_comedian" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-2"></i>Add to Lineup
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('cancel_event', event_id=event.id) }}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-ban me-2"></i>Cancel This Date
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('lineup-container');
    const saveStatus = document.getElementById('save-status');
    
    if (container) {
        let draggedElement = null;
        let draggedAfterElement = null;
        
        // Make items draggable and add event listeners
        function initializeDragAndDrop() {
            const items = container.querySelectorAll('.lineup-item');
            items.forEach(item => {
                item.draggable = true;
                
                // Add drag handles
                const dragHandle = item.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.addEventListener('mousedown', function() {
                        dragHandle.style.cursor = 'grabbing';
                    });
                    
                    dragHandle.addEventListener('mouseup', function() {
                        dragHandle.style.cursor = 'grab';
                    });
                }
                
                item.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.style.opacity = '0.5';
                    this.style.transform = 'rotate(5deg)';
                    
                    // Store the original position
                    draggedAfterElement = this.nextElementSibling;
                });
                
                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '';
                    this.style.transform = '';
                    
                    // Check if position actually changed
                    if (draggedElement && draggedAfterElement !== this.nextElementSibling) {
                        saveLineupOrder();
                    }
                    
                    draggedElement = null;
                    draggedAfterElement = null;
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== this) {
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        
                        if (e.clientY < midpoint) {
                            this.parentNode.insertBefore(draggedElement, this);
                        } else {
                            this.parentNode.insertBefore(draggedElement, this.nextSibling);
                        }
                    }
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                });
            });
        }
        
        // Function to save lineup order
        function saveLineupOrder() {
            const signupIds = Array.from(container.querySelectorAll('.lineup-item')).map(item => 
                item.getAttribute('data-signup-id')
            );
            
            saveStatus.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Saving order...</span>';
            
            fetch(`/host/reorder_lineup/{{ event.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ signup_ids: signupIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    saveStatus.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Order saved!</span>';
                    
                    // Update position badges
                    const items = container.querySelectorAll('.lineup-item');
                    items.forEach((item, index) => {
                        const badge = item.querySelector('.badge');
                        if (badge) {
                            badge.textContent = `#${index + 1}`;
                            badge.className = 'badge bg-primary me-2';
                        }
                    });
                    
                    setTimeout(() => {
                        saveStatus.innerHTML = '';
                    }, 3000);
                } else {
                    saveStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i>Error saving order</span>';
                    setTimeout(() => {
                        saveStatus.innerHTML = '';
                    }, 5000);
                }
            })
            .catch(error => {
                console.error('Error saving lineup order:', error);
                saveStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i>Error saving order</span>';
                setTimeout(() => {
                    saveStatus.innerHTML = '';
                }, 5000);
            });
        }
        
        // Initialize drag and drop
        initializeDragAndDrop();
        
        // Add visual feedback for dragging
        container.addEventListener('dragenter', function(e) {
            e.preventDefault();
            container.classList.add('drag-over');
        });
        
        container.addEventListener('dragleave', function(e) {
            e.preventDefault();
            if (!container.contains(e.relatedTarget)) {
                container.classList.remove('drag-over');
            }
        });
        
        container.addEventListener('drop', function(e) {
            e.preventDefault();
            container.classList.remove('drag-over');
        });
    }
});

// Function to randomize lineup order
function randomizeLineup() {
    const container = document.getElementById('lineup-container');
    if (!container) return;
    
    const items = Array.from(container.querySelectorAll('.lineup-item'));
    if (items.length < 2) {
        alert('Need at least 2 comedians to randomize lineup');
        return;
    }
    
    if (confirm('Randomize the lineup order? This will shuffle all performers randomly.')) {
        // Shuffle array using Fisher-Yates algorithm
        for (let i = items.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [items[i], items[j]] = [items[j], items[i]];
        }
        
        // Re-append items in new order
        items.forEach(item => container.appendChild(item));
        
        // Save the new order
        const signupIds = items.map(item => item.getAttribute('data-signup-id'));
        const saveStatus = document.getElementById('save-status');
        
        saveStatus.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Saving randomized order...</span>';
        
        fetch(`/host/reorder_lineup/{{ event.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ signup_ids: signupIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveStatus.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Lineup randomized!</span>';
                
                // Update position badges
                items.forEach((item, index) => {
                    const badge = item.querySelector('.badge');
                    if (badge) {
                        badge.textContent = `#${index + 1}`;
                        badge.className = 'badge bg-primary me-2';
                    }
                });
                
                setTimeout(() => {
                    saveStatus.innerHTML = '';
                }, 3000);
            } else {
                saveStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i>Error randomizing</span>';
            }
        })
        .catch(error => {
            console.error('Error randomizing lineup:', error);
            saveStatus.innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i>Error randomizing</span>';
        });
    }
}
</script>

<style>
.lineup-item {
    transition: all 0.2s ease;
}

.lineup-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.drag-over {
    background-color: #f8f9fa;
    border: 2px dashed #007bff;
}

.lineup-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.drag-handle:hover {
    color: #007bff !important;
}

.lineup-item:hover .drag-handle {
    color: #007bff !important;
}
</style>
{% endblock %}
